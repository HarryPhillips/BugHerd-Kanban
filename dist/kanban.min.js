/*
*   @type javascript
*   @name config.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name events.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name states.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name buffer.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name cache.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name util.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name coutner.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name http.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name node.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name router.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name modal.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name console.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name gui.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*    @type javascript test
*    @name main.test.js
*    @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name main.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name kanban.js
*   @copy Copyright 2015 Harry Phillips
*/

function kbsExpandObjectNode(e){"450px"!==e.parentNode.style.height?(e.parentNode.style.height="450px",e.className+=" kbs-rotate"):(e.parentNode.style.height="150px",e.className=e.className.replace("kbs-rotate",""))}if(define("config",{appName:"kbs",version:.9,enabled:!0,mode:"dev",offline:!1,test:!0,logs:{enabled:!0,gui:!0,filter:!1},gui:{enabled:!0,autorefresh:!0,console:{state:"kbs-open",autoscroll:!0,icons:{save:"file-text",clear:"trash",toggle:"terminal",close:"times",destroy:"unlink",example:"plus-circle",expand:"caret-square-o-right"}}},events:{silent:!1},routes:{console:{save:"kanban/endpoint/console/SaveBuffer.php"}},tooltips:{save:"Save the output buffer to text file",clear:"Clear all logs",toggle:"GUI Console State",close:"Close the console",destroy:"Destroy this console instance"}}),define("src/components/events",["config"],function(e){function t(){this.topics={}}return t.prototype.subscribe=function(e,t){this.topics[e]||(this.topics[e]=[]),this.topics[e].push(t)},t.prototype.publish=function(t,n){if(this.topics[t]){var o;for(o=0;o<this.topics[t].length;o+=1)this.topics[t][o](n);"object"!=typeof n&&(n={data:n})}else if(!e.events.silent)throw new Error("Event '"+t+"' does not exist!")},new t}),define("src/components/status",{app:!1,gui:!1,console:!1}),define("src/components/buffer",[],function(){function e(e){t.push(e||""),this.index=t.length-1}var t=[];return e.prototype.writeToBuffer=function(e){var n=this.index;return"string"==typeof t[n]?void(t[n]+=e):t[n]instanceof Array?void t[n].push(e):void 0},e.prototype.removeFromBuffer=function(e){var n,o=this.index;return"string"==typeof t[o]?void(t[o]=t[o].replace(e,"")):t[o]instanceof Array?(n=t[o].indexOf(e),void t[o].splice(n,1)):void 0},e.prototype.getBuffer=function(){return t[this.index]},e.prototype.getGlobalBuffer=function(){return t},e.prototype.clearBuffer=function(){var e=this.index;t.splice(e,1)},e}),define("src/components/cache",["./buffer"],function(e){var t={kbs:new e,console:new e};return t}),define("src/util",["config","./components/events","./components/status","./components/cache"],function(e,t,n,o){var s={};return s.zerofy=function(e,t){for(;e.toString().length<(t||2);)e="0"+e;return e},s.spacify=function(e,t){for("string"!=typeof e&&(e=e.toString());e.length<t;)e=" "+e;return e},s.ftime=function(){var e=new Date,t=s.zerofy(e.getHours()),n=s.zerofy(e.getMinutes()),o=s.zerofy(e.getSeconds()),i=s.zerofy(e.getMilliseconds(),3);return t+":"+n+":"+o+"."+i},s.fdate=function(){var e=new Date,t=s.zerofy(e.getFullYear(),4),n=s.zerofy(e.getMonth(),2),o=s.zerofy(e.getDate(),2);return t+"-"+n+"-"+o},s.escapeRegEx=function(e){var t;return t=String(e).replace(/([\-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1"),t=t.replace(/\x08/g,"\\x08")},s.isArray=function(){},s.contains=function(e,t,n){var o,i=0,r=[];if(n=n||!1,!n)return-1!==e.indexOf(t);if(t=s.escapeRegEx(t),o=new RegExp("(\\W|^)"+t+"(\\W|$)"),s.isArray(e)){for(;i<e.length;)o.test(e[i])&&r.push(i),i+=1;return 0===r.length?!1:r.length>1?r:r[0]}return o.test(e)?!0:!1},s.log=function(i,r,c){if(e.logs.enabled){var l,a=0,u=[],d=e.logs.filter,p=[],f="",h=!1,m="",g="",b="";for(l in arguments)arguments.hasOwnProperty(l)&&u.push(arguments[l]);if(u.length>2?"object"==typeof r&&(h=r,r=c):u.length>1?"object"==typeof i?(h=i,i="log"):"object"==typeof r&&(h=r,r=""):(r=i,i="log","object"==typeof r&&(h=r,r="")),!d||!s.contains(d,i,!0))for(f+="["+e.appName+"] ",f+=s.ftime(),f+=" "+s.spacify("["+i+"]",8)+":> ",f+=r,p.push(f),h&&(g="Object "+JSON.stringify(h,null,4)),b=f.replace(/\s/g," "),b=encodeURIComponent(b),b+=""!==g?"\n"+g:"",b+="\n",o.console.writeToBuffer(b),e.logs.gui&&n.console&&(m=f.replace(/\s/g," "),t.publish("gui/log",{msg:m,type:i,obj:g})),window.console[i]||(i="log"),h&&p.push(h);a<p.length;)window.console[i](p[a]),a+=1}},s.log("+ util.js loaded"),s}),define("src/components/counter",[],function(){function e(e,t){var n=0;this.target=e,this.exec=t,Object.defineProperty(this,"count",{get:function(){return n},set:function(t){n=t,n>=e&&this.exec()}})}return e}),define("src/components/http",["src/util","./counter"],function(e){function t(e){this.url=e.url,this.method=e.method||"GET",this.async=e.async||!0,this.data=e.data,this.callbacks={},this.callbacks.success=e.success||function(){},this.callbacks.fail=e.fail||function(){},n=this,e.send&&this.send(this.data)}var n;return t.prototype.encodeData=function(e){var t,n="";for(t in e)e.hasOwnProperty(t)&&(n+=t+"="+e[t]+"& ");return n},t.prototype.send=function(){var t=new XMLHttpRequest;t.open(this.method,this.url,this.async),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){4===this.readyState&&(200===this.status&&this.status<400?(e.log("debug","HTTP 200: "+n.url),n.callbacks.success(this.responseText)):(e.log("debug","HTTP "+this.status+": "+n.url),n.callbacks.fail(this.responseText)))},t.send(n.encodeData(n.data)),t=null},t}),define("src/ui/node",["config"],function(){function e(e,t,n){this.type=e,this.classes=t,this.selector=n,this.element=document.createElement(e),this.element.className=t||"",n&&(this.element.id=n)}return e.prototype.addChild=function(t){return t.constructor===e||t instanceof e?void this.element.appendChild(t.element):void this.element.appendChild(t)},e.prototype.createChild=function(t,n,o){var s=new e(t,n,o);return this.addChild(s.element),s},e.prototype.destroy=function(){this.element.parentNode.removeChild(this.element)},e.prototype.clone=function(){var t=new e(this.type,this.classes,this.selector);return t.element=null,t.element=this.element.cloneNode(),t},e}),define("src/components/router",["config"],function(e){return{getRoute:function(t,n){return window.KBS_BASE_URL+e.routes[t][n]}}}),define("src/ui/modal",["config","src/util","src/components/events","src/components/http","src/components/status","./node"],function(e,t,n,o,s,i){function r(e,t,n){c=this,"string"!=typeof e&&(n=t,t=e,e=null),l=t,this.type=e,this.node=new i("div","kbs-modal"),this.node.element.style.display="none",e&&(this.node.element.className+=" kbs-"+e),this.onConfirm=n.confirm||function(){},this.onCancel=n.cancel||function(){},this.title=n.title,this.message=n.message,n.init&&this.init()}var c,l;return r.prototype.init=function(){var e,t,n=this.node.createChild("h2","kbs-modal-title"),o=this.node.createChild("p","kbs-modal-msg"),s=this.node.createChild("i","fa fa-times kbs-modal-close");n.element.textContent=this.title,o.element.textContent=this.message,s.element.onclick=function(){c.close()},this.node.addChild(n),this.node.addChild(s),this.node.addChild(o),"prompt"===this.type&&(e=this.node.createChild("span","kbs-confirm"),e.element.textContent="confirm",e.element.onclick=this.onConfirm,t=this.node.createChild("span","kbs-cancel"),t.element.textContent="cancel",t.element.onclick=this.onCancel,this.node.addChild(e),this.node.addChild(t)),l.addChild(this.node.element),this.open()},r.prototype.open=function(){l.tree.main.overlay.element.style.display="block",this.node.element.style.display="block"},r.prototype.close=function(){l.tree.main.overlay.element.style.display="none",this.node.element.style.display="none"},r}),define("src/ui/console",["config","src/util","src/components/events","src/components/http","src/components/status","src/components/router","src/components/cache","src/ui/node","src/ui/modal"],function(e,t,n,o,s,i,r,c,l){function a(t){if(e.logs.gui){if(u=this,"undefined"==typeof t)throw new Error("No GUI instance passed to Console");d=t,this.buildNodeTree(),n.publish("kbs/status",{component:"console",status:!0})}}var u,d;return a.prototype.write=function(t){var n,o=u.wrapper.cons.out.element,s=new c("div","kbs-log-node kbs-"+t.type),i=document.createTextNode(t.msg),r=new c("pre","kbs-object"),l=new c("i","fa fa-"+e.gui.console.icons.expand+" kbs-object-expand");s.addChild(i),t.obj&&(n=document.createTextNode(t.obj),l.element.setAttribute("onclick","kbsExpandObjectNode(this)"),r.addChild(l.element),r.addChild(n),s.addChild(r.element)),o.appendChild(s.element),u.refresh()},a.prototype.createTool=function(t,n){if("undefined"==typeof t)throw new Error("No toolbar passed to GUI.Console.createTool()");var o;return o=this.getIcon(n),t[n]=t.createChild("i","fa fa-"+o+" kbs-tool kbs-"+n),t[n].element.title=e.tooltips[n]||"",t[n]},a.prototype.getIcon=function(t){return e.gui.console.icons[t]||"plus"},a.prototype.open=function(){var e=this.wrapper.element,t=e.className;e.className=t.replace(" kbs-close"," kbs-open")},a.prototype.close=function(){var e=this.wrapper.element,t=e.className;e.className=t.replace(" kbs-open"," kbs-close")},a.prototype.shrink=function(){},a.prototype.full=function(){},a.prototype.refresh=function(){var e=u.wrapper.cons.element;e.scrollTop=e.scrollHeight},a.prototype.clear=function(){var e,n=this.wrapper.cons.element,o=this.wrapper.cons.out.element,s=(new Date).getTime();for(n.removeChild(o);o.firstChild;)o.removeChild(o.firstChild);n.appendChild(o),e=(new Date).getTime()-s,t.log("okay","cleared all logs in "+e+" ms")},a.prototype.save=function(){{var e=(t.ftime(),t.fdate()),n=r.console.getBuffer();new o({url:i.getRoute("console","save"),method:"POST",send:!0,data:{date:e,buffer:n},success:function(e){t.log("okay",e)}})}},a.prototype.destroy=function(){var e="Destroy the Console instance?",t="Confirm destruction of the GUI Console? (irreversible until refresh).",n=new l("prompt",d,{init:!0,title:e,message:t,confirm:function(){var e=u.wrapper.element.parentNode,t=u.wrapper.element;e.removeChild(t),r.console.clearBuffer(),n.close()},cancel:function(){n.close()}})},a.prototype.buildNodeTree=function(){var t,n,o,s,i,r,c;return n="kbs-cons-box "+e.gui.console.state,this.wrapper=t=d.createChild("div",n),o=t.constools=t.createChild("div","kbs-cons-toolbar"),s=o.constitle=o.createChild("div","kbs-cons-title"),i=document.createTextNode("Kanban v"+e.version),s.element.appendChild(i),this.createTool(o,"toggle").element.onclick=function(){var e=t.element.className,n=-1!==e.indexOf("kbs-close"),o=-1!==e.indexOf("kbs-full");n||o||(t.element.className+=" kbs-full"),o&&(t.element.className=t.element.className.replace(" kbs-full","")),n&&u.open()},this.createTool(o,"save").element.onclick=function(){u.save()},this.createTool(o,"destroy").element.onclick=function(){u.destroy()},this.createTool(o,"clear").element.onclick=function(){u.clear()},this.createTool(o,"close").element.onclick=function(){u.close()},t.cons=r=t.createChild("div","kbs-cons"),c=r.out=r.createChild("div","kbs-cons-out"),t},a}),define("src/ui/gui",["require","config","src/util","src/components/events","./node","src/components/counter","./console","./modal"],function(e){function t(){n=this,this.tree=this.buildNodeTree(),this.console=new l(this),this.modal=new a(this,{init:!1,title:"Test Modal - Title",message:"Test paragraph / modal content."}),i.publish("kbs/status",{component:"gui",status:!0})}var n,o=e("config"),s=e("src/util"),i=e("src/components/events"),r=e("./node"),c=e("src/components/counter"),l=e("./console"),a=e("./modal");return s.log("+ gui.js loaded"),t.prototype.init=function(){var e=new c(o.offline?2:3,function(){i.publish("kbs/gui/loaded")}),t=document.createElement("link"),r=document.createElement("link"),l=document.createElement("link"),a=window.KBS_BASE_URL+window.KBS_SRC_DIR+"css/main.css",u=window.KBS_BASE_URL+window.KBS_SRC_DIR+"css/theme.css",d="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css",p=function(){document.body.appendChild(n.tree.main.element),s.log("debug","+ attached gui tree"),s.log("debug","+ publishing 'kbs/loaded'"),i.publish("kbs/loaded")};i.subscribe("kbs/gui/loaded",p),t.rel="stylesheet",r.rel="stylesheet",l.rel="stylesheet",t.href=a,r.href=u,l.href=d,t.onload=function(){s.log("debug","+ main.css loaded"),e.count+=1},t.onerror=function(){throw e.count+=1,new Error("main.css failed to load!")},r.onload=function(){s.log("debug","+ theme.css loaded"),e.count+=1},r.onerror=function(){throw e.count+=1,new Error("theme.css failed to load!")},l.onload=function(){s.log("debug","+ font-awesome.css loaded"),e.count+=1},l.onerror=function(){throw e.count+=1,new Error("font-awesome.css failed to load!")},o.offline||document.head.appendChild(l),document.head.appendChild(t),document.head.appendChild(r),o.gui.enabled&&(o.gui.autorefresh&&i.subscribe("gui/update",this.refresh),o.logs.gui&&i.subscribe("gui/log",this.console.write))},t.prototype.buildNodeTree=function(){var e,t={};return t.main=e=new r("div","kbs-gui"),e.overlay=t.main.createChild("div","kbs-overlay"),t},t.prototype.refresh=function(){this.console.refresh()},t.prototype.addChild=function(e){this.tree.main.element.appendChild(e)},t.prototype.createChild=function(e,t,n){var o=new r(e,t,n);return this.tree.main.element.appendChild(o.element),o},t.prototype.benchmark=function(){var e,t=n.console.wrapper.cons.element,o=n.console.wrapper.cons.out.element,i=(new Date).getTime(),r=0;for(t.removeChild(o);1e4>r;)s.log("debug","log #"+r),r+=1;t.appendChild(o),e=(new Date).getTime()-i,s.log("debug","opt: "+e+"ms")},t.prototype.getCurrentInstance=function(){return n},t}),define("test/main.test",["require","src/util"],function(e,t){return{exec:function(n){t.log("test",'executing test: "'+n+'"'),e(["./"+n+".test"])}}}),define("src/main",["config","./components/events","./util","./components/status","./components/http","./components/cache","./ui/gui","test/main.test"],function(e,t,n,o,s,i,r,c){var l,a,u;e.enabled&&(t.subscribe("kbs/status",function(e){o[e.component]=e.status}),e.gui.enabled&&(u=new r,u.init()),a=function(){window.KBS_END_TIME=(new Date).getTime()-window.KBS_START_TIME+"ms",n.log("okay","Kanban initialised in "+window.KBS_END_TIME),"dev"===e.mode&&(window[e.appName]=l),t.publish("kbs/status",{component:"app",status:!0}),e.test&&c.exec(["util"])},l={version:e.version,status:o,cache:i,config:e,events:t,http:s,util:n,gui:u},t.subscribe("kbs/loaded",a))}),!window.KBS_GLOBAL_SET)var KBS_GLOBAL_SET=!0,KBS_START_TIME=(new Date).getTime(),KBS_END_TIME,KBS_BASE_URL="http://localhost/proj/",KBS_SRC_DIR="kanban/";!function(e){var t=e.require;t.config({paths:{src:"src",test:"test"}}),t(["src/main"])}(window),define("kanban",function(){});