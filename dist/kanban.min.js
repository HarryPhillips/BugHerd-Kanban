/*
*   @type javascript
*   @name config.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name events.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name states.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name buffer.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name cache.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name util.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name coutner.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name http.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name interactor.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name node.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name router.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name modal.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name console.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name gui.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*    @type javascript test
*    @name main.test.js
*    @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name main.js
*   @copy Copyright 2015 Harry Phillips
*/

/*
*   @type javascript
*   @name kanban.js
*   @copy Copyright 2015 Harry Phillips
*/

!function(){if(define("config",{appName:"kbs",version:.9,enabled:!0,mode:"dev",httpToken:"Fw43Iueh87aw7",test:!0,logs:{enabled:!0,gui:!0,contexts:!0,contextFlag:"context:",obj2buffer:!1,filter:!1},gui:{enabled:!0,autorefresh:!0,console:{state:"kbs-open",autoscroll:!0,icons:{save:"file-text",clear:"trash",toggle:"terminal",close:"times",destroy:"unlink",example:"plus-circle",expand:"caret-square-o-right"}}},events:{silent:!1},routes:{console:{save:"endpoint/SaveBuffer.php"}},tooltips:{save:"Save the output buffer to text file",clear:"Clear all logs",toggle:"GUI Console State",close:"Close the console",destroy:"Destroy this console instance"}}),define("src/components/events",["config"],function(e){function t(){this.topics={}}return t.prototype.subscribe=function(e,t){this.topics[e]||(this.topics[e]=[]),this.topics[e].push(t)},t.prototype.publish=function(t,n){if(this.topics[t]){var o;for(o=0;o<this.topics[t].length;o+=1)this.topics[t][o](n);"object"!=typeof n&&(n={data:n})}else if(!e.events.silent)throw new Error("Event '"+t+"' does not exist!")},new t}),define("src/components/status",{app:!1,gui:!1,console:!1}),define("src/components/buffer",[],function(){function e(e){t.push(e||""),this.index=t.length-1}var t=[];return e.prototype.writeToBuffer=function(e){var n=this.index;return"string"==typeof t[n]?void(t[n]+=e):t[n]instanceof Array?void t[n].push(e):void 0},e.prototype.removeFromBuffer=function(e){var n,o=this.index;return"string"==typeof t[o]?void(t[o]=t[o].replace(e,"")):t[o]instanceof Array?(n=t[o].indexOf(e),void t[o].splice(n,1)):void 0},e.prototype.getBuffer=function(){return t[this.index]},e.prototype.getGlobalBuffer=function(){return t},e.prototype.clearBuffer=function(){var e=this.index;t.splice(e,1)},e}),define("src/components/cache",["./buffer"],function(e){var t={app:new e,console:new e};return t}),define("src/util",["config","./components/events","./components/status","./components/cache"],function(e,t,n,o){var s={};return s.zerofy=function(e,t){for(;e.toString().length<(t||2);)e="0"+e;return e},s.spacify=function(e,t){for("string"!=typeof e&&(e=e.toString());e.length<t;)e=" "+e;return e},s.ftime=function(){var e=new Date,t=s.zerofy(e.getHours()),n=s.zerofy(e.getMinutes()),o=s.zerofy(e.getSeconds()),i=s.zerofy(e.getMilliseconds(),3);return t+":"+n+":"+o+"."+i},s.fdate=function(){var e=new Date,t=s.zerofy(e.getFullYear(),4),n=s.zerofy(e.getMonth(),2),o=s.zerofy(e.getDate(),2);return t+"-"+n+"-"+o},s.escapeRegEx=function(e){var t;return t=String(e).replace(/([\-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1"),t=t.replace(/\x08/g,"\\x08")},s.isNode=function(e){return"Node"===e.constructor.name},s.isArray=function(e){return e instanceof Array||"Array"===e.constructor},s.contains=function(e,t,n){function o(e,t){if(!n)return-1!==e.indexOf(t);if(t=s.escapeRegEx(t),i=new RegExp("(\\W|^)"+t+"(\\W|$)"),s.isArray(e)){for(;c<e.length;)i.test(e[c])&&l.push(c),c+=1;return n?0===l.length?!1:l.length>1?l:l[0]:!0}return i.test(e)?!0:!1}var i,r,c=0,l=[];if("undefined"==typeof t||""===t)return!1;if(n=n||!1,!s.isArray(t))return o(e,t);for(c=0;c<t.length;c+=1)if(r=o(e,t[c]),r!==!1)return r;return!1},s.log=function(i,r,c,l){function a(){l=c,c=r,r=i}if(e.logs.enabled){var u,d=0,p=[],f=e.logs.filter,h=[],m="",g=!1,b=!1,y="",v="",x="",w=e.logs.contextFlag;for(u in arguments)arguments.hasOwnProperty(u)&&p.push(arguments[u]);if(e.logs.contexts?"string"==typeof i&&-1!==i.indexOf(w)?s.log.currentContext!==!1?(b=i.replace(w,""),i=s.log.currentContext,p.shift()):(i=i.replace(w,""),p.shift()):(a(),i=s.log.currentContext):(-1!==i.indexOf(w)?p.shift():a(),i=!1,b=!1),p.length>2?"object"==typeof c&&(g=c,c=l):p.length>1?"object"==typeof r?(g=r,r="log"):"object"==typeof c&&(g=c,c=""):(c=r,r="log","object"==typeof c&&(g=c,c="")),!f||s.contains(f,r,!0)===!1)for(m+=s.ftime(),m+=" ["+(b||i||e.appName)+"]",m+=" ["+r+"]:> ",m+=c,h.push(m),g&&(v="Object "+JSON.stringify(g,null,4)),x=m.replace(/\s/g," "),x=encodeURIComponent(x),x+=e.logs.obj2buffer?""!==v?"\n"+v:"":""!==v?"\n[object omitted]":"",x+="\n",o.console.writeToBuffer(x),e.logs.gui&&n.console&&(y=m.replace(/\s/g," "),t.publish("gui/log",{msg:y,type:r,obj:v,context:i,subcontext:b})),window.console[r]||(r="log"),g&&h.push(g);d<h.length;)window.console[r](h[d]),d+=1}},s.log.currentContext=s.log.currentContext||!1,s.log.beginContext=function(t){return e.logs.contexts?-1!==t.indexOf(e.logs.contextFlag)?void s.log("error","You shouldn't pass the context flag when using beginContext()"):void(s.log.currentContext=t):void 0},s.log.endContext=function(){s.log.currentContext=!1},s.log("+ util.js loaded"),s}),define("src/components/counter",[],function(){function e(e,t){var n=0,o=!1;this.target=e,this.exec=t,Object.defineProperty(this,"count",{get:function(){return n},set:function(t){n=t,n>=e&&!o&&(o=!0,this.exec())}})}return e}),define("src/components/http",["config","src/util","./counter"],function(e,t){function n(e){this.url=e.url,this.method=e.method||"GET",this.async=e.async||!0,this.data=e.data,this.callbacks={},this.callbacks.success=e.success||function(){},this.callbacks.fail=e.fail||function(){},o=this,e.send&&this.send(this.data)}var o,s=e.httpToken;return n.prototype.encodeData=function(e){var t,n="";for(t in e)e.hasOwnProperty(t)&&(n+=t+"="+e[t]+"&");return s&&(n+="kbstoken="+s),n},n.prototype.send=function(){var e=new XMLHttpRequest;e.open(this.method,this.url,this.async),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){4===this.readyState&&(200===this.status&&this.status<400?(t.log("debug","HTTP 200: "+o.url),o.callbacks.success(this.responseText)):(t.log("debug","HTTP "+this.status+": "+o.url),o.callbacks.fail(this.responseText)))},e.send(o.encodeData(o.data)),e=null},n}),define("src/interactor",["require","src/util"],function(e){function t(){o.log("context:inter/init","info","Initialising Interactor..."),this.init()}var n,o=e("src/util");return t.prototype.init=function(){return"undefined"==typeof window.jQuery?void o.log("context:inter/init","error","Interactor could not initialise, jQuery not found!"):(n=window.jQuery,this.applyElements(),void this.applyStyles())},t.prototype.applyElements=function(){o.log("context:inter/init","debug","+ appending elements to bugherd"),n(".nav.main-nav").append("<li><a href='javascript:void(0)'>Expand Task</a></li>")},t.prototype.applyStyles=function(){o.log("context:inter/init","debug","+ applying styles to bugherd"),n(".nav.user-menu").css("margin-right","10px")},t}),define("src/ui/node",["config"],function(){function e(e,t,n){this.type=e,this.classes=t,this.selector=n,this.element=document.createElement(e),this.element.className=t||"",n&&(this.element.id=n)}return e.prototype.addChild=function(t){return t.constructor===e||t instanceof e?void this.element.appendChild(t.element):void this.element.appendChild(t)},e.prototype.createChild=function(t,n,o){var s=new e(t,n,o);return this.addChild(s.element),s},e.prototype.destroy=function(){this.element.parentNode.removeChild(this.element)},e.prototype.clone=function(){var t=new e(this.type,this.classes,this.selector);return t.element=null,t.element=this.element.cloneNode(),t},e}),define("src/components/router",["config"],function(e){return{getRoute:function(t,n){return window.KBS_BASE_URL+e.routes[t][n]}}}),define("src/ui/modal",["config","src/util","src/components/events","src/components/http","src/components/status","./node"],function(e,t,n,o,s,i){function r(e,t,n){c=this,"string"!=typeof e&&(n=t,t=e,e=null),l=t,this.type=e,this.node=new i("div","kbs-modal"),this.node.element.style.display="none",e&&(this.node.element.className+=" kbs-"+e),this.onConfirm=n.confirm||function(){},this.onCancel=n.cancel||function(){},this.title=n.title,this.message=n.message,n.init&&this.init()}var c,l;return r.prototype.init=function(){var e,t,n=this.node.createChild("h2","kbs-modal-title"),o=this.node.createChild("p","kbs-modal-msg"),s=this.node.createChild("i","fa fa-times kbs-modal-close");n.element.textContent=this.title,o.element.textContent=this.message,s.element.onclick=function(){c.close()},this.node.addChild(n),this.node.addChild(s),this.node.addChild(o),"prompt"===this.type&&(e=this.node.createChild("span","kbs-confirm"),e.element.textContent="confirm",e.element.onclick=this.onConfirm,t=this.node.createChild("span","kbs-cancel"),t.element.textContent="cancel",t.element.onclick=this.onCancel,this.node.addChild(e),this.node.addChild(t)),l.addChild(this.node.element),this.open()},r.prototype.open=function(){l.tree.main.overlay.element.style.display="block",this.node.element.style.display="block"},r.prototype.close=function(){l.tree.main.overlay.element.style.display="none",this.node.element.style.display="none"},r.prototype.destroy=function(){l.tree.main.overlay.element.style.display="none",this.node.element.parentNode.removeChild(this.node.element)},r}),define("src/ui/console",["config","src/util","src/components/events","src/components/http","src/components/status","src/components/router","src/components/cache","src/ui/node","src/ui/modal"],function(e,t,n,o,s,i,r,c,l){function a(t){if(e.logs.gui){if(u=this,"undefined"==typeof t)throw new Error("No GUI instance passed to Console");d=t,this.buildNodeTree(),this.setContexts(),n.publish("kbs/status",{component:"console",status:!0})}}var u,d;return a.prototype.setContexts=function(){this.contexts||(this.contexts={def:u.wrapper.cons.out.element})},a.prototype.getContext=function(t){return e.logs.contexts?this.contexts[t]:this.contexts.def},a.prototype.createContext=function(n,o){if(e.logs.contexts){var s;return this.contexts[n]&&t.log("error","Log context: '"+n+"' is already defined"),t.isNode(o)?(s=o.createChild("div","kbs-log-context"),s.element.id=n):(s=new c("div","kbs-log-context"),s.element.id=n,o.appendChild(s.element)),this.contexts[n]=s.element,o}},a.prototype.write=function(n){var o,s,i=u.getContext("def"),r=new c("div","kbs-log-node kbs-"+n.type),l=document.createTextNode(n.msg),a=new c("pre","kbs-object"),d=new c("i","fa fa-"+e.gui.console.icons.expand+" kbs-object-expand"),p=!1;n.context&&(n.subcontext?u.getContext(n.subcontext)?i=u.getContext(n.subcontext):(i=u.getContext(n.context),p=n.subcontext):u.getContext(n.context)?i=u.getContext(n.context):p=n.context),r.addChild(l),n.obj&&(s=document.createTextNode(n.obj),d.element.onclick=function(e){var n=e.target,o=n.parentNode;t.contains(o.className,"kbs-expand")?(o.className=o.className.replace(" kbs-expand",""),n.className=n.className.replace(" kbs-rotate","")):(o.className+=" kbs-expand",n.className+=" kbs-rotate")},a.addChild(d.element),a.addChild(s),r.addChild(a.element)),o=i.parentNode.className,"test"===n.type&&t.contains(o,"kbs-exec")&&(r.element.className+=" kbs-log-close"),i.appendChild(r.element),p&&u.createContext(p,r.element),u.refresh()},a.prototype.writeToContext=function(e){this.findLogContext(e)||t.log("error","Attempt to write to a log context ('"+e+"') which does not exist!")},a.prototype.createTool=function(t){var n,o=this.wrapper.constools;if("undefined"==typeof o)throw new Error("Could not create new tool, no toolbar!");return n=this.getIcon(t),o[t]=o.createChild("i","fa fa-"+n+" kbs-tool kbs-"+t),o[t].element.title=e.tooltips[t]||"",o[t]},a.prototype.getIcon=function(t){return e.gui.console.icons[t]||"plus"},a.prototype.open=function(){var e=this.wrapper.element,t=e.className;e.className=t.replace(" kbs-close"," kbs-open")},a.prototype.close=function(){var e=this.wrapper.element,t=e.className;e.className=t.replace(" kbs-open"," kbs-close")},a.prototype.shrink=function(){},a.prototype.full=function(){},a.prototype.refresh=function(){var e=u.wrapper.cons.element;e.scrollTop=e.scrollHeight},a.prototype.clear=function(){var e,n=this.wrapper.cons.element,o=this.wrapper.cons.out.element,s=(new Date).getTime();for(n.removeChild(o);o.firstChild;)o.removeChild(o.firstChild);n.appendChild(o),e=(new Date).getTime()-s,t.log("okay","cleared all logs in "+e+" ms")},a.prototype.save=function(){{var e=(t.ftime(),t.fdate()),n=r.console.getBuffer();new o({url:i.getRoute("console","save"),method:"POST",send:!0,data:{type:"log",date:e,buffer:n},success:function(e){t.log("okay",e)}})}},a.prototype.destroy=function(){var e="Destroy the Console instance?",t="Confirm destruction of the GUI Console? (irreversible until refresh).",n=new l("prompt",d,{init:!0,title:e,message:t,confirm:function(){var e=u.wrapper.element.parentNode,t=u.wrapper.element;e.removeChild(t),r.console.clearBuffer(),n.destroy()},cancel:function(){n.close()}})},a.prototype.buildNodeTree=function(){var t,n,o,s,i,r,c;return n="kbs-cons-box "+e.gui.console.state,this.wrapper=t=d.createChild("div",n),o=t.constools=t.createChild("div","kbs-cons-toolbar"),s=o.constitle=o.createChild("div","kbs-cons-title"),i=document.createTextNode("Kanban v"+e.version),s.element.appendChild(i),this.createTool("toggle").element.onclick=function(){var e=t.element.className,n=-1!==e.indexOf("kbs-close"),o=-1!==e.indexOf("kbs-full");n||o||(t.element.className+=" kbs-full"),o&&(t.element.className=t.element.className.replace(" kbs-full","")),n&&u.open()},this.createTool("save").element.onclick=function(){u.save()},this.createTool("destroy").element.onclick=function(){u.destroy()},this.createTool("clear").element.onclick=function(){u.clear()},this.createTool("close").element.onclick=function(){u.close()},t.cons=r=t.createChild("div","kbs-cons"),c=r.out=r.createChild("div","kbs-cons-out"),t},a}),define("src/ui/gui",["require","config","src/util","src/components/events","src/interactor","./node","src/components/counter","./console","./modal"],function(e){function t(){n=this,this.tree=this.buildNodeTree(),this.console=new l(this),this.modal=new a(this,{init:!1,title:"Test Modal - Title",message:"Test paragraph / modal content."}),this.init(),i.publish("kbs/status",{component:"gui",status:!0})}var n,o=e("config"),s=e("src/util"),i=e("src/components/events"),r=(e("src/interactor"),e("./node")),c=e("src/components/counter"),l=e("./console"),a=e("./modal");return s.log("+ gui.js loaded"),t.prototype.init=function(){var e=new c(o.offline?2:3,function(){i.publish("kbs/gui/loaded")}),t=document.createElement("link"),r=document.createElement("link"),l=document.createElement("link"),a=window.KBS_BASE_URL+"css/main.css",u=window.KBS_BASE_URL+"css/"+(o.theme||"theme")+".css",d="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css",p=function(){document.body.appendChild(n.tree.main.element),s.log("context:gui/init","debug","+ attached gui tree"),n.runEventListeners(),s.log("context:gui/init","debug","+ running event listeners"),s.log("context:gui/init","debug","+ publishing 'kbs/loaded'"),i.publish("kbs/loaded")};o.gui.enabled&&(o.gui.autorefresh&&i.subscribe("gui/update",this.refresh),o.logs.gui&&i.subscribe("gui/log",this.console.write),i.subscribe("kbs/gui/loaded",p)),t.rel="stylesheet",r.rel="stylesheet",l.rel="stylesheet",t.href=a,r.href=u,l.href=d,s.log("context:gui/init","info","Initialising GUI..."),t.onload=function(){s.log("context:gui/init","debug","+ main.css loaded"),e.count+=1},t.onerror=function(){throw e.count+=1,new Error("main.css failed to load!")},r.onload=function(){s.log("context:gui/init","debug","+ theme.css loaded"),e.count+=1},r.onerror=function(){throw e.count+=1,new Error("theme.css failed to load!")},l.onload=function(){s.log("context:gui/init","debug","+ font-awesome.css loaded"),e.count+=1},l.onerror=function(){throw e.count+=1,new Error("font-awesome.css failed to load!")},o.offline||document.head.appendChild(l),document.head.appendChild(t),document.head.appendChild(r)},t.prototype.buildNodeTree=function(){var e,t={};return t.main=e=new r("div","kbs-gui"),e.overlay=t.main.createChild("div","kbs-overlay"),t},t.prototype.runEventListeners=function(){var e,t,n=this.console.wrapper.cons.out.element;t=o.logs.contexts?["kbs-exec","kbs-test"]:"",n.onclick=function(n){e=n.target,s.contains(e.className,t)!==!1&&(s.contains(e.className,"kbs-log-close")?e.className=e.className.replace(" kbs-log-close",""):e.className+=" kbs-log-close")}},t.prototype.refresh=function(){this.console.refresh()},t.prototype.addChild=function(e){this.tree.main.element.appendChild(e)},t.prototype.createChild=function(e,t,n){var o=new r(e,t,n);return this.tree.main.element.appendChild(o.element),o},t.prototype.benchmark=function(){var e,t=n.console.wrapper.cons.element,o=n.console.wrapper.cons.out.element,i=(new Date).getTime(),r=0;for(t.removeChild(o);1e4>r;)s.log("debug","log #"+r),r+=1;t.appendChild(o),e=(new Date).getTime()-i,s.log("debug","opt: "+e+"ms")},t.prototype.getCurrentInstance=function(){return n},t}),define("test/main.test",["require","src/util"],function(e,t){return{exec:function(n){t.log("context:test/"+n,"exec",'executing test: "'+n+'"...'),e([window.KBS_BASE_URL+"test/"+n+".test.js"])}}}),define("src/main",["require","config","./components/events","./util","./components/status","./components/http","./components/cache","./ui/gui","./interactor","test/main.test"],function(e){var t,n,o,s,i,r,c,l,a,u,d,p,f;t=e("config"),t.enabled&&(n=e("./components/events"),o=e("./util"),s=e("./components/status"),i=e("./components/http"),r=e("./components/cache"),c=e("./ui/gui"),l=e("./interactor"),a=e("test/main.test"),n.subscribe("kbs/status",function(e){s[e.component]=e.status}),t.gui.enabled&&(p=new c),f=new l,d=function(){window.KBS_DELTA_TIME=(new Date).getTime()-window.KBS_START_TIME+"ms",o.log("okay","Kanban initialised in "+window.KBS_DELTA_TIME),"dev"===t.mode&&(window[t.appName]=u),"undefined"==typeof window.log&&(window.log=o.log),n.publish("kbs/status",{component:"app",status:!0}),t.test&&a.exec(["util"])},u={version:t.version,interactor:f,status:s,cache:r,config:t,events:n,http:i,util:o,gui:p},n.subscribe("kbs/loaded",d),t.gui.enabled||n.publish("kbs/loaded"))}),!window.KBS_GLOBAL_SET)var e=((new Date).getTime(),"http://localhost/GitHub/");!function(t){var n=t.require;n.config({paths:{src:e+"src",test:e+"test"}}),n(["src/main"])}(window),define("kanban",function(){})}();